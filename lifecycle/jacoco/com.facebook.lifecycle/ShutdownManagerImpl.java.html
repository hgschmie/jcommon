<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShutdownManagerImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jcommon lifecycle</a> &gt; <a href="index.html" class="el_package">com.facebook.lifecycle</a> &gt; <span class="el_source">ShutdownManagerImpl.java</span></div><h1>ShutdownManagerImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2012 Facebook, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.facebook.lifecycle;

import org.apache.log4j.Logger;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Runtime.addShutdownHook() has no guarantee of order.  This class
 * will run hooks by stage and in the order added within stages
 */
public class ShutdownManagerImpl&lt;T extends Enum&gt; implements ShutdownManager&lt;T&gt; {
<span class="fc" id="L30">  private static final Logger LOG = Logger.getLogger(ShutdownManagerImpl.class);</span>

<span class="fc" id="L32">  private final Map&lt;T, List&lt;Runnable&gt;&gt; shutdownHooksByStage = new ConcurrentHashMap&lt;&gt;();</span>
  private final Thread thread;
<span class="fc" id="L34">  private final Object shutdownLock = new Object();</span>
  private final T[] stages;
  private final T firstStage;
  private final T lastStage;
  private final T defaultStage;

  private T currentStage;
<span class="fc" id="L41">  private boolean isShutdown = false;</span>

<span class="fc" id="L43">  public ShutdownManagerImpl(Class&lt;T&gt; enumClazz, T defaultStage) {</span>
<span class="fc" id="L44">    this.defaultStage = defaultStage;</span>

<span class="pc bpc" id="L46" title="1 of 2 branches missed.">    if (!enumClazz.isEnum()) {</span>
<span class="nc" id="L47">      throw new IllegalArgumentException(</span>
        String.format(
          &quot;%s is not an enum class&quot;, enumClazz.getName()
        )
      );
    }

<span class="fc" id="L54">    stages = enumClazz.getEnumConstants();</span>
<span class="fc bfc" id="L55" title="All 2 branches covered.">    for (T stage : stages) {</span>
<span class="fc" id="L56">      shutdownHooksByStage.put(stage, new ArrayList&lt;Runnable&gt;());</span>
    }

    // three values : being/end sentinel and at least one usable value 
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">    if (stages.length &lt; 3) {</span>
<span class="nc" id="L61">      throw new IllegalArgumentException(&quot;enum class must have at least 3 values&quot;);</span>
    }

<span class="fc" id="L64">    firstStage = stages[0];</span>
<span class="fc" id="L65">    currentStage = firstStage;</span>
<span class="fc" id="L66">    lastStage = stages[stages.length - 1];</span>
<span class="fc" id="L67">    thread = new Thread(</span>
<span class="fc" id="L68">      new Runnable() {</span>
        @Override
        public void run() {
<span class="nc" id="L71">          internalShutdown();</span>
<span class="nc" id="L72">        }</span>
      }
    );
<span class="fc" id="L75">  }</span>

  @Override
  public boolean tryAddShutdownHook(Runnable hook) {
<span class="nc" id="L79">    return tryAddShutdownHook(defaultStage, hook);</span>
  }

  @Override
  public boolean tryAddShutdownHook(T stage, Runnable hook) {
<span class="pc bpc" id="L84" title="2 of 4 branches missed.">    if (stage == firstStage || stage == lastStage) {</span>
<span class="nc" id="L85">      throw new IllegalArgumentException(</span>
        String.format(&quot;stage %s is reserved&quot;, stage)
      );
    }

<span class="fc" id="L90">    synchronized (shutdownLock) {</span>
      //if the stage being added is our stage or earlier, we can't accept this
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">      if (stage.compareTo(currentStage) &lt;= 0) {</span>
<span class="nc" id="L93">        LOG.warn(</span>
          String.format(
            &quot;cannot add hook for stage %s when in stage %s&quot;,
            stage,
            currentStage
          )
        );
<span class="nc" id="L100">        return false;</span>
      }

<span class="fc" id="L103">      shutdownHooksByStage.get(stage).add(hook);</span>

<span class="fc" id="L105">      return true;</span>
<span class="nc" id="L106">    }</span>
  }

  @Override
  public void addShutdownHook(Runnable hook) {
<span class="fc" id="L111">    addShutdownHook(defaultStage, hook);</span>
<span class="fc" id="L112">  }</span>

  @Override
  public void addShutdownHook(T stage, Runnable hook) {
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">    if (!tryAddShutdownHook(stage, hook)) {</span>
<span class="nc" id="L117">      throw new IllegalStateException(</span>
        &quot;trying to add a hook after shutdown started&quot;
      );
    }
<span class="fc" id="L121">  }</span>

  @Override
  public void shutdown() {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">    if (internalShutdown()) {</span>
      // fb303.shutdown calls this, so remove the shutdown hook after we're done
<span class="fc" id="L127">      Runtime.getRuntime().removeShutdownHook(thread);</span>
    }
<span class="fc" id="L129">  }</span>

  @Override
  public Thread getAsThread() {
<span class="nc" id="L133">    return thread;</span>
  }

  /**
   * @return true if this executed the shutdown
   */
  private boolean internalShutdown() {
<span class="fc" id="L140">    synchronized (shutdownLock) {</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">      if (isShutdown) {</span>
<span class="nc" id="L142">        LOG.info(&quot;ignoring extra shutdown call&quot;);</span>

<span class="nc" id="L144">        return false;</span>
      }

<span class="fc" id="L147">      isShutdown = true;</span>
<span class="pc" id="L148">    }</span>

<span class="fc" id="L150">    LOG.info(&quot;starting service shutdown hooks&quot;);</span>

<span class="fc bfc" id="L152" title="All 2 branches covered.">    for (T stage : stages) {</span>
<span class="fc" id="L153">      LOG.info(&quot;starting stage &quot; + stage);</span>
<span class="fc" id="L154">      synchronized (shutdownLock) {</span>
<span class="fc" id="L155">        currentStage = stage;</span>
<span class="pc" id="L156">      }</span>

<span class="fc bfc" id="L158" title="All 2 branches covered.">      for (Runnable hook : shutdownHooksByStage.get(stage)) {</span>
        try {
<span class="fc" id="L160">          hook.run();</span>
<span class="nc" id="L161">        } catch (Throwable t) {</span>
<span class="nc" id="L162">          LOG.warn(&quot;error running hook&quot;, t);</span>
<span class="fc" id="L163">        }</span>
<span class="fc" id="L164">      }</span>

<span class="fc" id="L166">      LOG.info(&quot;ending stage &quot; + stage);</span>
    }

<span class="fc" id="L169">    LOG.info(&quot;shutdown complete&quot;);</span>

<span class="fc" id="L171">    return true;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.0.201210061924</span></div></body></html>