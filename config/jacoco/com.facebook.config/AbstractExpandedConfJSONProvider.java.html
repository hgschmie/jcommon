<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractExpandedConfJSONProvider.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jcommon config</a> &gt; <a href="index.html" class="el_package">com.facebook.config</a> &gt; <span class="el_source">AbstractExpandedConfJSONProvider.java</span></div><h1>AbstractExpandedConfJSONProvider.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2012 Facebook, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.facebook.config;

import org.apache.log4j.Logger;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.Queue;
import java.util.Set;

/**
 * Reads and expands a JSON config object through a series of includes.
 * Expects JSON config objects to consist of two top level keys: 'conf' and 'includes':
 *
 * conf - key-value pairs to be consolidated in the returned JSONObject [req]
 * includes - list of JSON configs (of the same format) from which to pull and
 *    include key-value pairs [opt]
 *
 * JSON config file format:
 * {
 *  conf : {
 *    key1 : value1,
 *    key2 : value2
 *    ...
 *  },
 *  includes : [
 *    object1,
 *    object2
 *   ]
 * }
 *
 * Keys in the existing or closer config objects will take precedence over the same
 * key defined in more distantly included objects.
 */
public abstract class AbstractExpandedConfJSONProvider implements JSONProvider {
<span class="fc" id="L54">  private static final Logger LOG = Logger.getLogger(AbstractExpandedConfJSONProvider.class);</span>
  private static final String CONF_KEY = &quot;conf&quot;;
  private static final String INCLUDES_KEY = &quot;includes&quot;;

  private final String root;

<span class="fc" id="L60">  public AbstractExpandedConfJSONProvider(String root) {</span>
<span class="fc" id="L61">    this.root = root;</span>
<span class="fc" id="L62">  }</span>

  private JSONObject getExpandedJSONConfig() throws JSONException {
<span class="fc" id="L65">    Set&lt;String&gt; traversedFiles = new HashSet&lt;&gt;();</span>
<span class="fc" id="L66">    Queue&lt;String&gt; toTraverse = new LinkedList&lt;&gt;();</span>

    // Seed the graph traversal with the root node
<span class="fc" id="L69">    traversedFiles.add(root);</span>
<span class="fc" id="L70">    toTraverse.add(root);</span>

    // Policy: parent configs will override children (included) configs
<span class="fc" id="L73">    JSONObject expanded = new JSONObject();</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">    while (!toTraverse.isEmpty()) {</span>
<span class="fc" id="L75">      String current = toTraverse.remove();</span>
<span class="fc" id="L76">      JSONObject json = load(current);</span>
<span class="fc" id="L77">      JSONObject conf = json.getJSONObject(CONF_KEY);</span>
<span class="fc" id="L78">      Iterator&lt;String&gt; iter = conf.keys();</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">      while (iter.hasNext()) {</span>
<span class="fc" id="L80">        String key = iter.next();</span>
        // Current config will get to insert keys before its include files
<span class="fc bfc" id="L82" title="All 2 branches covered.">        if (!expanded.has(key)) {</span>
<span class="fc" id="L83">          expanded.put(key, conf.get(key));</span>
        }
<span class="fc" id="L85">      }</span>
      // Check if the file itself has any included files
<span class="fc bfc" id="L87" title="All 2 branches covered.">      if (json.has(INCLUDES_KEY)) {</span>
<span class="fc" id="L88">        JSONArray includes = json.getJSONArray(INCLUDES_KEY);</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        for (int idx = 0; idx &lt; includes.length(); idx++) {</span>
<span class="fc" id="L90">          String include = resolve(current, includes.getString(idx));</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">          if (traversedFiles.contains(include)) {</span>
<span class="fc" id="L92">            LOG.warn(&quot;Config file was included twice: &quot; + include);</span>
          } else {
<span class="fc" id="L94">            toTraverse.add(include);</span>
<span class="fc" id="L95">            traversedFiles.add(include);</span>
          }
        }
      }
<span class="fc" id="L99">    }</span>

<span class="fc" id="L101">    return expanded;</span>
  }

  @Override
  public JSONObject get() throws JSONException {
<span class="fc" id="L106">    return getExpandedJSONConfig();</span>
  }

  /**
   * Determines the canonical resource identifier for the given &lt;tt&gt;config&lt;/tt&gt;.
   * This hook allows subclasses to resolve relative paths used in includes.
   *
   * @param parent the resource which listed this config in its includes
   *               (or &lt;tt&gt;null&lt;/tt&gt; if it is the root)
   * @param config a config resource identifier
   * @return the canonical resource identifier
   * @see com.facebook.config.ExpandedConfFileJSONProvider#resolve(String, String)
   */
  abstract protected String resolve(String parent, String config);

  /**
   * Returns the configuration JSON identified by &lt;tt&gt;config&lt;/tt&gt;.
   * &lt;tt&gt;config&lt;/tt&gt; is guaranteed to be the result of some call to
   * {@link #resolve(String, String)}.
   *
   * @param config a canonical resource identifier
   * @return a JSON representation of the resource's contents
   * @see com.facebook.config.ExpandedConfFileJSONProvider#load(String)
   */
  abstract protected JSONObject load(String config) throws JSONException;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.0.201210061924</span></div></body></html>